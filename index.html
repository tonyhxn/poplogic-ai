<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pop Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            background-color: #12285a !important; /* Dark Navy Blue */
        }
        .screen {
            display: none;
            width: 100%;
            min-height: 100vh;
            overflow-y: auto;
            padding-top: 60px; /* Space for global banner */
            padding-bottom: 20px; /* Ensure space for descenders */
        }
        .active-screen {
            display: flex;
        }
        .balloon {
            width: 80px;
            height: 90px;
            border-radius: 50%;
            transition: transform 0.2s ease-out;
            cursor: pointer;
            position: relative;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.8), rgba(255,255,255,0.3) 40%, rgba(255,255,255,0) 70%),
                radial-gradient(circle at 70% 30%, rgba(255,255,255,0.4), rgba(255,255,255,0) 50%);
            box-shadow: 
                inset 0 2px 4px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.1),
                0 4px 8px rgba(0,0,0,0.2);
        }
        .balloon:hover {
            /* Removed hover effect for Level 2 simulation */
        }
        .balloon.pre-explode {
            animation: pre-explode 0.5s ease-out forwards;
        }
        @keyframes pre-explode {
            0% { transform: scale(0.5); }
            50% { transform: scale(0.8); }
            100% { transform: scale(1.2); }
        }
        .balloon::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 10px solid currentColor;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }
        .balloon-string {
            position: absolute;
            bottom: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 50px;
            background: linear-gradient(to bottom, #FFFFFF, #F0F0F0);
            border-radius: 2px;
            animation: string-float 6s ease-in-out infinite;
            transform-origin: top center;
            box-shadow: 0 0 2px rgba(0,0,0,0.1);
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.8), transparent 30%),
                radial-gradient(circle at 80% 40%, rgba(255,255,255,0.6), transparent 40%),
                radial-gradient(circle at 40% 60%, rgba(255,255,255,0.7), transparent 35%),
                radial-gradient(circle at 70% 80%, rgba(255,255,255,0.5), transparent 45%);
            border-radius: 50px;
            transform: translateX(-50%) scaleY(1.2) scaleX(0.3);
        }
        @keyframes string-float {
            0% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(-4deg) translateY(0px) skewX(1deg);
            }
            8% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(3deg) translateY(-2px) skewX(-0.5deg);
            }
            16% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(-2deg) translateY(1px) skewX(1.5deg);
            }
            24% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(4deg) translateY(-1px) skewX(-1deg);
            }
            32% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(-3deg) translateY(2px) skewX(0.5deg);
            }
            40% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(2deg) translateY(-1px) skewX(-1.5deg);
            }
            48% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(-4deg) translateY(1px) skewX(1deg);
            }
            56% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(3deg) translateY(-2px) skewX(-0.5deg);
            }
            64% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(-2deg) translateY(2px) skewX(1.5deg);
            }
            72% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(4deg) translateY(-0.5px) skewX(-1deg);
            }
            80% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(-3deg) translateY(1px) skewX(0.5deg);
            }
            88% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(2deg) translateY(-1px) skewX(-1.5deg);
            }
            96% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(-3deg) translateY(0.5px) skewX(1deg);
            }
            100% { 
                transform: translateX(-50%) scaleY(1.2) scaleX(0.3) rotate(-4deg) translateY(0px) skewX(1deg);
            }
        }
        .balloon-face {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 40%;
        }
        .eye {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            top: 0;
            transition: transform 0.2s ease;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .eye.left { left: 4px; }
        .eye.right { right: 4px; }
        .eye::after {
            content: '';
            position: absolute;
            width: 5px;
            height: 5px;
            background: black;
            border-radius: 50%;
            top: 2.5px;
            left: 2.5px;
        }
        .mouth {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 6px;
            background: transparent;
            border: 4px solid rgba(0,0,0,0.4);
            border-top: none;
            border-radius: 0 0 30px 30px;
        }
        .pump-jiggle {
            animation: pump-jiggle 0.3s ease-in-out;
        }
        @keyframes pump-jiggle {
            0%, 100% { transform: scale(var(--scale, 1)) rotate(0deg); }
            25% { transform: scale(var(--scale, 1)) rotate(-2deg); }
            75% { transform: scale(var(--scale, 1)) rotate(2deg); }
        }
        @keyframes hover-wobble {
            0%, 100% { transform: scale(var(--scale, 1)) rotate(0deg); }
            25% { transform: scale(var(--scale, 1)) translateY(-2px) rotate(1deg); }
            75% { transform: scale(var(--scale, 1)) translateY(0px) rotate(-1deg); }
        }
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            animation: explode 0.7s ease-out forwards;
        }
        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: var(--transform-end) scale(0); opacity: 0; }
        }
        .conveyor-belt-item {
            animation: conveyor-process 4s ease-out forwards;
        }
        @keyframes conveyor-process {
            0% { transform: translateX(-250px) translateY(-50%); }
            50% { transform: translateX(0) translateY(-50%); }
            80% { opacity: 1; }
            100% { transform: translateX(0) translateY(-50%); opacity: 0; }
        }
        .btn { transition: transform 0.1s ease, background-color 0.2s; }
        .btn:active { transform: scale(0.95); }
        
        #tutorial-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
        }
        .tutorial-highlight {
            position: absolute;
            border-radius: 1.5rem;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
            z-index: 1000;
            transition: all 0.5s ease-in-out;
        }
        #tutorial-box {
            position: absolute;
            background: #312e81;
            color: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            border: 2px solid #4f46e5;
            max-width: 350px;
            z-index: 1001;
            transition: all 0.5s ease-in-out;
        }
        .slide-toggle-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .performance-bar {
            background-color: #374151; /* gray-700 */
            border-radius: 9999px;
            height: 8px;
            width: 100%;
            overflow: hidden;
        }
        .performance-bar-inner {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        .animated-title {
            background: linear-gradient(45deg, #ef4444, #3b82f6, #10b981, #f59e0b, #8b5cf6, #ef4444);
            background-size: 300% 300%;
            animation: gradientShift 3s ease-in-out infinite, balloonFloat 3s ease-in-out infinite 0.6s;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback for browsers that don't support background-clip */
            opacity: 1 !important; /* Ensure title is always visible */
        }
        
        /* Fallback for browsers that don't support background-clip: text */
        @supports not (background-clip: text) {
            .animated-title {
                background: none;
                color: #ffffff;
                text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            }
        }
        @keyframes balloonFloat {
            0%, 100% { 
                transform: translateY(0px);
            }
            50% { 
                transform: translateY(-8px);
            }
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .title-bounce {
            animation: balloonBurst 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }
        @keyframes balloonBurst {
            0% { 
                transform: scale(0) rotate(-15deg);
                opacity: 0;
            }
            100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        /* Weather Effects */
        .rain-drop {
            position: absolute;
            width: 3px;
            height: 25px;
            background: linear-gradient(to bottom, transparent, #3b82f6, #1d4ed8);
            animation: rainFall 0.8s linear infinite;
            box-shadow: 0 0 6px #3b82f6;
        }
        
        .snow-flake {
            position: absolute;
            color: #ffffff;
            font-size: 16px;
            animation: snowFall 4s linear infinite;
            text-shadow: 0 0 10px #e0e7ff;
        }
        
        .heat-wave {
            position: absolute;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, #fbbf24, #f59e0b, #fbbf24, transparent);
            animation: heatRipple 1.5s ease-in-out infinite;
            box-shadow: 0 0 20px #fbbf24;
        }
        
        .storm-cloud {
            position: absolute;
            width: 200px;
            height: 100px;
            background: linear-gradient(135deg, #374151, #1f2937, #111827);
            border-radius: 50px 20px 50px 20px;
            animation: stormCloud 3s ease-in-out infinite;
            opacity: 0.8;
        }
        
        .lightning {
            position: absolute;
            width: 2px;
            height: 100px;
            background: linear-gradient(to bottom, #fbbf24, #ffffff, #fbbf24);
            animation: lightning 0.1s linear infinite;
            box-shadow: 0 0 20px #fbbf24;
        }
        
        .ice-crystal {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, #e0f2fe, #b3e5fc, #81d4fa);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: iceFall 3s linear infinite;
            box-shadow: 0 0 15px #81d4fa;
        }
        
        .heat-distortion {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 0%, rgba(251, 191, 36, 0.1) 50%, transparent 100%);
            animation: heatDistortion 2s ease-in-out infinite;
        }
        
        @keyframes rainFall {
            0% { transform: translateY(-100vh) translateX(0); opacity: 1; }
            100% { transform: translateY(100vh) translateX(30px); opacity: 0; }
        }
        
        @keyframes snowFall {
            0% { transform: translateY(-100vh) translateX(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) translateX(80px) rotate(720deg); opacity: 0; }
        }
        
        @keyframes heatRipple {
            0%, 100% { transform: translateY(0) scaleX(0); opacity: 0; }
            50% { transform: translateY(-30px) scaleX(1); opacity: 0.8; }
        }
        
        @keyframes stormCloud {
            0%, 100% { transform: translateX(-200px) translateY(0); opacity: 0.8; }
            50% { transform: translateX(calc(100vw + 200px)) translateY(-20px); opacity: 0.6; }
        }
        
        @keyframes lightning {
            0%, 90% { opacity: 0; }
            95% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        @keyframes iceFall {
            0% { transform: translateY(-100vh) translateX(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) translateX(60px) rotate(360deg); opacity: 0; }
        }
        
        @keyframes heatDistortion {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.1; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.3; }
        }
        @keyframes sunPulse {
            0%, 100% { transform: translateX(-50%) scale(1); opacity: 0.7; }
            50% { transform: translateX(-50%) scale(1.1); opacity: 1; }
        }
        .subtitle-slide {
            animation: subtitleSlide 0.6s ease-out 0.3s both;
        }
        @keyframes subtitleSlide {
            0% { 
                transform: translateY(50px);
                opacity: 0;
            }
            100% { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        .description-fade {
            animation: descriptionFade 0.8s ease-out 0.6s both;
        }
        @keyframes descriptionFade {
            0% { 
                transform: translateY(30px);
                opacity: 0;
            }
            100% { 
                transform: translateY(0);
                opacity: 1;
            }
        }
        .button-pop {
            animation: buttonPop 0.5s ease-out 0.9s both;
        }
        @keyframes buttonPop {
            0% { 
                transform: scale(0) rotate(-5deg);
                opacity: 0;
            }
            100% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        #custom-tooltip {
            position: fixed;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            pointer-events: none;
            transform: translate(-50%, -100%);
            margin-top: -8px;
        }
        #custom-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }
    </style>
</head>
<body class="bg-indigo-900 text-white">

    <!-- Global Banner -->
    <div id="global-banner" class="fixed top-0 left-0 right-0 bg-indigo-900/80 backdrop-blur-sm p-3 text-center z-50 border-b border-indigo-700">
        <h3 class="text-sm font-semibold tracking-wider text-indigo-300 mb-2">TOTAL $ PUMPED BY PLAYERS</h3>
        <div class="flex justify-center items-center space-x-4 md:space-x-8 text-xs md:text-sm">
            <div><span class="font-bold text-red-400">RED:</span> $<span id="global-red">10000</span></div>
            <div><span class="font-bold text-blue-400">BLUE:</span> $<span id="global-blue">5000</span></div>
            <div><span class="font-bold text-green-400">GREEN:</span> $<span id="global-green">3453</span></div>
            <div><span class="font-bold text-yellow-400">YELLOW:</span> $<span id="global-gold">1500</span></div>
        </div>
    </div>

    <!-- Home Button -->
    <button id="home-btn" class="fixed top-20 left-4 z-50 bg-indigo-500 hover:bg-indigo-600 p-3 rounded-full shadow-lg transition hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
    </button>
    
    <!-- Help Button -->
     <button id="help-btn" class="fixed top-20 right-4 z-50 bg-amber-500 hover:bg-amber-600 p-3 rounded-full shadow-lg transition hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
    </button>


    <!-- Main Menu Screen -->
    <div id="main-menu" class="screen active-screen flex-col justify-center items-center p-4 text-center" style="padding-top: 80px; padding-bottom: 40px;">
        <h1 id="main-title" class="text-4xl md:text-7xl font-black mb-6 animated-title" style="line-height: 1.1;">POP LOGIC</h1>
        <h2 id="main-subtitle" class="text-2xl md:text-3xl font-bold text-indigo-200 mb-6" style="margin-top: 1rem;">Welcome to the Balloon Factory</h2>
        
        <div class="max-w-4xl mb-8">
            <p class="text-lg text-indigo-300 mt-4 mb-6 leading-relaxed">
                You're the new AI engineer at PopLogic Balloon Factory! Your mission is to maximize yield 
                by training AI systems to pump balloons perfectly. Each balloon has a secret maximum capacity - 
                pump too little and you miss profit, pump too much and it pops!
            </p>
            
            <div class="bg-indigo-800/30 border border-indigo-600 rounded-2xl p-6 mb-6">
                <p class="text-2xl font-bold text-green-400 mb-2">"Pump and Earn, Pop it Lose it"</p>
                <p class="text-indigo-300 text-sm">The factory's golden rule</p>
            </div>
            
            <p class="text-lg text-indigo-300 leading-relaxed">
                Master AI concepts through interactive balloon experiments. Learn pattern recognition, 
                model training, and temperature control in this engaging educational game.
            </p>
        </div>
        
        <button id="start-game-btn" class="btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-10 rounded-2xl text-xl shadow-lg transform hover:scale-105">Enter the Factory</button>
    </div>

    <!-- Level Select Screen -->
    <div id="level-select" class="screen flex-col justify-center items-center p-4">
        <div class="text-center">
            <h1 class="text-5xl font-bold mb-8">Select a Mode</h1>
            <div class="grid md:grid-cols-3 gap-8 w-full max-w-5xl">
                <button id="select-l1-btn" class="btn bg-indigo-800/80 p-6 rounded-3xl text-left hover:bg-indigo-700 border border-indigo-600 transition">
                    <h2 class="text-2xl font-bold">Level 1: Human Training</h2>
                    <p class="text-indigo-300 mt-2">Learn the basics of pattern recognition and data bias by training yourself first.</p>
                </button>
                <button id="select-l2-btn" class="btn bg-indigo-800/80 p-6 rounded-3xl text-left hover:bg-indigo-700 border border-indigo-600 transition">
                     <h2 class="text-2xl font-bold">Level 2: AI Supervisor</h2>
                    <p class="text-indigo-300 mt-2">Build a simple AI and act as its Human-in-the-Loop supervisor to guide its performance.</p>
                </button>
                <button id="select-l3-btn" class="btn bg-indigo-800/80 p-6 rounded-3xl text-left hover:bg-indigo-700 border border-indigo-600 transition">
                     <h2 class="text-2xl font-bold">Open Game Mode</h2>
                    <p class="text-indigo-300 mt-2">Test your adaptive strategy in an infinite mode with a dynamic, unpredictable environment.</p>
                </button>
            </div>
             <button id="reset-progress-btn" class="btn mt-8 text-indigo-300 hover:text-white hover:bg-red-500/50 py-2 px-4 rounded-lg">Reset All Progress</button>
        </div>
    </div>
    
    <!-- Level 1 Screen -->
    <div id="level-1" class="screen flex-col justify-center items-center p-4" style="padding-top: 120px;">
        <div class="w-full max-w-6xl mx-auto flex flex-col lg:flex-row gap-8">
            <div id="l1-game-area" class="flex-grow lg:w-3/5 bg-indigo-800/50 p-6 rounded-3xl border border-indigo-700 flex flex-col items-center justify-between">
                 <div id="l1-history-panel" class="bg-indigo-900/50 p-4 rounded-2xl border border-indigo-700 w-full mb-4">
                    <h3 class="text-lg font-bold mb-2 text-center text-indigo-200">Last 8 Balloons</h3>
                    <div id="l1-history" class="grid grid-cols-8 gap-x-2 justify-items-center text-center text-sm h-16 items-center"></div>
                </div>
                <div class="w-full text-center">
                    <p class="text-indigo-300">Level 1: Human Training</p>
                    <h2 id="l1-progress" class="text-2xl font-bold">Balloon 1 of 15</h2>
                </div>
                <div id="l1-balloon-area" class="w-full h-64 flex justify-center items-center my-4 relative"></div>
                <div id="l1-controls" class="w-full">
                    <div class="w-full flex flex-col md:flex-row gap-4">
                        <button id="l1-pump-btn" class="btn bg-green-500 hover:bg-green-600 flex-1 text-white font-bold py-4 px-6 rounded-2xl text-lg shadow-md">PUMP (+1)</button>
                        <button id="l1-bank-btn" class="btn bg-blue-500 hover:bg-blue-600 flex-1 text-white font-bold py-4 px-6 rounded-2xl text-lg shadow-md">CASH OUT ($<span id="l1-current-score">0</span>)</button>
                    </div>
                </div>
                 <div id="l1-summary-area" class="w-full text-center hidden mt-4">
                    <div id="l1-score-summary" class="mb-6"></div>
                    <div id="l1-educational-slides" class="bg-indigo-900/50 p-6 rounded-2xl">
                         <div id="slide-content" class="min-h-[150px]"></div>
                         <div class="flex justify-between items-center mt-4">
                             <button id="prev-slide-btn" class="btn bg-gray-500 hover:bg-gray-600 font-bold py-2 px-6 rounded-lg">Prev</button>
                             <span id="slide-indicator" class="font-mono text-sm">1 / 3</span>
                             <button id="next-slide-btn" class="btn bg-indigo-500 hover:bg-indigo-600 font-bold py-2 px-6 rounded-lg">Next</button>
                         </div>
                    </div>
                    <div class="flex gap-4 justify-center mt-6">
                         <button id="l1-summary-next-btn" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-2xl text-lg">Go to Level 2</button>
                         <button id="l1-summary-replay-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-2xl text-lg">Replay</button>
                    </div>
                </div>
            </div>
            <div class="lg:w-2/5 flex flex-col gap-8">
                <div id="l1-data-panel" class="bg-indigo-800/50 p-6 rounded-3xl border border-indigo-700">
                    <h3 class="text-xl font-bold mb-4 text-center">Your Personal Data</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-baseline"><span class="font-bold text-red-400 text-lg">Red:</span><div class="text-right"><span id="l1-red-score" class="text-xl font-mono">$0</span><span class="text-sm text-gray-400 block">Avg. Pumps: <span id="l1-red-avg">0.0</span></span></div></div>
                        <div class="flex justify-between items-baseline"><span class="font-bold text-blue-400 text-lg">Blue:</span><div class="text-right"><span id="l1-blue-score" class="text-xl font-mono">$0</span><span class="text-sm text-gray-400 block">Avg. Pumps: <span id="l1-blue-avg">0.0</span></span></div></div>
                        <div class="flex justify-between items-baseline"><span class="font-bold text-green-400 text-lg">Green:</span><div class="text-right"><span id="l1-green-score" class="text-xl font-mono">$0</span><span class="text-sm text-gray-400 block">Avg. Pumps: <span id="l1-green-avg">0.0</span></span></div></div>
                    </div>
                </div>
                <div class="bg-indigo-800/50 p-6 rounded-3xl border border-indigo-700">
                     <h3 id="l1-insights-title" class="text-xl font-bold mb-2 text-center">AI Insights</h3>
                     <div id="l1-insights" class="text-center text-indigo-300 min-h-[6rem] transition-opacity duration-500"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Level 2 Screen -->
    <div id="level-2" class="screen flex-col justify-center items-center p-4" style="padding-top: 120px;">
        <div class="w-full max-w-6xl mx-auto flex flex-col lg:flex-row gap-6">
            <div id="l2-control-panel" class="lg:w-1/3 bg-indigo-800/50 p-6 rounded-3xl border border-indigo-700 flex flex-col">
                <!-- Balloon Animation Simulation (moved here, smaller) -->
                <div id="l2-simulation-panel" class="bg-indigo-900/50 p-4 rounded-2xl border border-indigo-700 flex flex-col items-center mb-6">
                    <h3 class="text-lg font-bold mb-2">BALLOON FACTORY</h3>
                    <p class="text-xs text-gray-300 mb-3">Pump and Earn. Pop it and Lose it</p>
                    <div class="flex justify-end mb-2">
                        <button id="l2-skip-to-end-btn" class="text-xs bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 px-2 py-1 rounded transition hidden">
                            Skip to End
                        </button>
                    </div>
                    <div class="text-center mb-3">
                        <div class="text-2xl font-bold text-green-400 mb-1">$<span id="l2-earned-amount">0</span> EARNED</div>
                        <p class="text-xs text-indigo-300">Processed: <span id="l2-processed-count">0</span> / 100</p>
                    </div>
                    <div class="w-full h-40 bg-indigo-800/50 rounded-xl overflow-hidden relative border border-indigo-600">
                        <div id="l2-conveyor" class="absolute h-full w-full"></div>
                    </div>
                </div>
                
                <!-- AI Strategy Rules (moved under simulation) -->
                <h3 class="text-xl font-bold mb-4 text-center">AI Strategy Rules</h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-4"><label class="font-bold text-red-400 w-16">Red:</label><input type="range" id="l2-red-pumps" min="0" max="15" value="0" class="flex-1"><span id="l2-red-val" class="font-mono w-8 text-center">0</span></div>
                    <div class="flex items-center gap-4"><label class="font-bold text-blue-400 w-16">Blue:</label><input type="range" id="l2-blue-pumps" min="0" max="15" value="0" class="flex-1"><span id="l2-blue-val" class="font-mono w-8 text-center">0</span></div>
                    <div class="flex items-center gap-4"><label class="font-bold text-green-400 w-16">Green:</label><input type="range" id="l2-green-pumps" min="0" max="15" value="0" class="flex-1"><span id="l2-green-val" class="font-mono w-8 text-center">0</span></div>
                    <div class="flex items-center gap-4"><label class="font-bold text-yellow-400 w-16">Yellow:</label><input type="range" id="l2-yellow-pumps" min="0" max="15" value="0" class="flex-1"><span id="l2-yellow-val" class="font-mono w-8 text-center">0</span></div>
                </div>
                <div class="mt-6">
                    <button id="l2-start-stop-btn" class="btn bg-indigo-500 hover:bg-indigo-600 w-full text-white font-bold py-4 px-6 rounded-2xl text-lg shadow-md">RUN TEST</button>
                    
                    <!-- Navigation Buttons -->
                    <div class="flex gap-3 mt-3">
                        <button id="l2-back-to-learn-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-xl text-sm shadow-md flex-1">
                            Back to Learn
                        </button>
                        <button id="l2-open-game-btn" class="btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-xl text-sm shadow-md flex-1">
                            Open Game Mode
                        </button>
                    </div>
                </div>
                
            </div>
            
            <div class="flex-grow lg:w-2/3 bg-indigo-800/50 p-6 rounded-3xl border border-indigo-700 flex flex-col">
                <!-- Past Strategies Section (moved here, above performance monitor) -->
                <div id="l2-past-strategies" class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-bold text-indigo-200">Past Strategies</h3>
                        <button id="l2-clear-all-strategies" class="text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 px-2 py-1 rounded transition">
                            Clear All
                        </button>
                    </div>
                    <div id="l2-strategies-list" class="flex gap-4 overflow-x-auto pb-2" style="scrollbar-width: thin;">
                        <!-- Past strategies will be populated here -->
                    </div>
                </div>
                
                <!-- AI Performance Monitor -->
                <div class="w-full bg-indigo-900/50 p-4 rounded-2xl border border-indigo-700">
                    <h3 class="text-xl font-bold text-center mb-4">AI Performance Monitor</h3>
                    <div id="l2-performance-monitor" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Level 3 Screen -->
    <div id="level-3" class="screen flex-col justify-center items-center p-4">
        <!-- Weather Effects Container -->
        <div id="weather-effects" class="fixed inset-0 pointer-events-none z-0">
            <div id="rain-drops" class="absolute inset-0 hidden"></div>
            <div id="snow-flakes" class="absolute inset-0 hidden"></div>
            <div id="heat-waves" class="absolute inset-0 hidden"></div>
        </div>
        
        <div class="w-full max-w-6xl mx-auto flex flex-col lg:flex-row gap-6 relative z-10">
            <!-- Control Panel -->
            <div class="lg:w-1/3 bg-indigo-800/50 p-6 rounded-3xl border border-indigo-700 flex flex-col">
                <!-- Weather Station -->
                <div class="bg-gradient-to-br from-blue-900/30 to-purple-900/30 p-4 rounded-2xl border border-blue-600/50 mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-bold text-blue-200">🌡️ Factory Climate Control</h3>
                        <div id="weather-icon" class="text-2xl">🌡️</div>
                    </div>
                    <div class="text-center">
                        <p id="l3-temp-display" class="text-4xl font-black transition-all duration-1000 mb-2">20°C</p>
                        <p id="weather-status" class="text-sm text-blue-300">Optimal Conditions</p>
                        <div class="mt-2 h-2 bg-blue-900/50 rounded-full overflow-hidden">
                            <div id="temp-bar" class="h-full bg-gradient-to-r from-blue-400 to-red-400 transition-all duration-1000" style="width: 50%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Strategy Rules -->
                <h3 class="text-xl font-bold mb-4 text-center">🎛️ AI Pump Settings</h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-4"><label class="font-bold text-red-400 w-16">Red:</label><input type="range" id="l3-red-pumps" min="1" max="25" value="8" class="w-full"><span id="l3-red-val" class="font-mono w-8 text-center">8</span></div>
                    <div class="flex items-center gap-4"><label class="font-bold text-blue-400 w-16">Blue:</label><input type="range" id="l3-blue-pumps" min="1" max="25" value="5" class="w-full"><span id="l3-blue-val" class="font-mono w-8 text-center">5</span></div>
                    <div class="flex items-center gap-4"><label class="font-bold text-green-400 w-16">Green:</label><input type="range" id="l3-green-pumps" min="1" max="25" value="6" class="w-full"><span id="l3-green-val" class="font-mono w-8 text-center">6</span></div>
                    <div class="flex items-center gap-4"><label class="font-bold text-yellow-400 w-16">Yellow:</label><input type="range" id="l3-yellow-pumps" min="1" max="30" value="10" class="w-full"><span id="l3-yellow-val" class="font-mono w-8 text-center">10</span></div>
                </div>
                
                <div class="mt-6">
                    <button id="l3-start-stop-btn" class="btn bg-green-500 hover:bg-green-600 w-full text-white font-bold py-4 px-6 rounded-2xl text-lg shadow-md">🚀 START PRODUCTION</button>
                </div>
                
                <div class="pt-8">
                    <h3 class="text-xl font-bold mb-2 text-center">🤖 AI Insights</h3>
                    <p id="l3-insights" class="text-center text-indigo-300 h-16 transition-opacity duration-500"></p>
                </div>
            </div>
            
            <!-- Production Floor -->
            <div class="flex-grow lg:w-2/3 bg-indigo-800/50 p-6 rounded-3xl border border-indigo-700 flex flex-col">
                <!-- Production Header -->
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold mb-2">🏭 PRODUCTION FLOOR</h3>
                    <p class="text-sm text-indigo-300 mb-4">Continuous Balloon Manufacturing - Weather Adaptive Mode</p>
                    <div class="flex justify-center items-center gap-8">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-400">$ <span id="l3-total-score">0</span></div>
                            <div class="text-xs text-indigo-300">Total Revenue</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-400"><span id="l3-balloons-processed">0</span></div>
                            <div class="text-xs text-indigo-300">Balloons Processed</div>
                        </div>
                    </div>
                </div>
                
                <!-- Conveyor Belt -->
                <div class="w-full h-32 bg-gradient-to-r from-indigo-900/50 to-purple-900/50 rounded-2xl overflow-hidden relative border-2 border-indigo-600 mb-6">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-indigo-500/20 to-transparent animate-pulse"></div>
                    <div id="l3-conveyor" class="absolute h-full w-full"></div>
                </div>
                
                <!-- Performance Monitor -->
                <div class="w-full bg-indigo-900/50 p-4 rounded-2xl border border-indigo-700">
                    <h3 class="text-xl font-bold text-center mb-4">📊 Production Analytics</h3>
                    <div id="l3-performance-monitor" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Tooltip -->
    <div id="custom-tooltip"></div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="fixed inset-0 z-[998] hidden">
        <div id="tutorial-highlight" class="tutorial-highlight"></div>
        <div id="tutorial-box" class="shadow-2xl">
            <h3 id="tutorial-title" class="text-xl font-bold mb-2"></h3>
            <p id="tutorial-text" class="text-indigo-200 mb-4"></p>
            <div class="flex gap-2 mt-4">
                 <button id="tutorial-prev-btn" class="btn bg-gray-500 hover:bg-gray-600 font-bold py-2 px-4 rounded-lg">Previous</button>
                 <button id="tutorial-next-btn" class="btn bg-indigo-500 hover:bg-indigo-600 flex-grow font-bold py-2 px-4 rounded-lg">Next</button>
            </div>
        </div>
        <!-- Skip Tutorial Button -->
        <button id="skip-tutorial-btn" class="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition z-[1002]">
            Skip Tutorial
        </button>
    </div>

    <!-- Level 2 Completion Modal -->
    <div id="l2-completion-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-indigo-900/95 backdrop-blur-sm border border-indigo-600 rounded-3xl p-8 max-w-md mx-4 text-center shadow-2xl">
            <div class="text-6xl mb-4">🎉</div>
            <h2 class="text-2xl font-bold text-green-400 mb-4">Simulation Complete!</h2>
            <p class="text-indigo-200 mb-6 leading-relaxed">
                By pausing and adjusting your AI, you acted as a Human-in-the-Loop. This is vital for safety and performance.
            </p>
            <button id="l2-modal-close" class="btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-8 rounded-2xl text-lg shadow-md">
                Continue
            </button>
        </div>
    </div>

    <script>
    // --- DOM Elements ---
    const screens = document.querySelectorAll('.screen');
    const homeBtn = document.getElementById('home-btn');
    const helpBtn = document.getElementById('help-btn');
    const startGameBtn = document.getElementById('start-game-btn');
    const selectL1Btn = document.getElementById('select-l1-btn');
    const selectL2Btn = document.getElementById('select-l2-btn');
    const selectL3Btn = document.getElementById('select-l3-btn');
    const resetProgressBtn = document.getElementById('reset-progress-btn');
    const tutorialOverlay = document.getElementById('tutorial-overlay');
    const tutorialBox = document.getElementById('tutorial-box');
    const tutorialPrevBtn = document.getElementById('tutorial-prev-btn');
    const tutorialNextBtn = document.getElementById('tutorial-next-btn');
    const customTooltip = document.getElementById('custom-tooltip');
    const skipTutorialBtn = document.getElementById('skip-tutorial-btn');
    const mainTitle = document.getElementById('main-title');
    const mainSubtitle = document.getElementById('main-subtitle');
    const mainDescription = document.getElementById('main-description');


    // --- Game Config ---
    const BALLOON_CONFIG = {
        red: { color: 'red-500', range: [6, 12], chartColor: '#EF4444' },
        blue: { color: 'blue-400', range: [4, 6], chartColor: '#60A5FA' },
        green: { color: 'green-400', range: [2, 8], chartColor: '#4ADE80' },
        yellow: { color: 'yellow-400', range: [1, 20], chartColor: '#FBBF24' },
    };

    const L1_SEQUENCE = ['red', 'red', 'red', 'red', 'blue', 'blue', 'blue', 'blue', 'green', 'red', 'blue', 'green', 'red', 'blue', 'green'];
    
    // --- Game State ---
    let gameState;

    function getDefaultGameState() {
        return {
            unlockedLevels: 1,
            tutorial: { l1: 0, l2: 0 },
            l1: { stats: {}, balloonIndex: 0, history: [], isPopping: false, strategy: {}, bestScore: 0 },
            l2: { stats: {}, processedCount: 0, strategy: {}, pastStrategies: [] },
            l3: { stats: {}, totalScore: 0, processedSinceChartUpdate: 0, temperature: 20, strategy: {} }
        };
    }

    function resetAllProgress() {
        localStorage.removeItem('popLogicState');
        initGame();
        goToLevelSelect();
    }
    
    function saveGameState() {
        const stateToSave = JSON.parse(JSON.stringify(gameState));
        if (stateToSave.l2) delete stateToSave.l2.chart;
        if (stateToSave.l3) delete stateToSave.l3.chart;
        localStorage.setItem('popLogicState', JSON.stringify(stateToSave));
    }

    function loadGameState() {
        const savedState = localStorage.getItem('popLogicState');
        if (savedState) {
            gameState = JSON.parse(savedState);
            if (!gameState.tutorial) gameState.tutorial = { l1: 0, l2: 0 };
            if (!gameState.l1.bestScore) gameState.l1.bestScore = 0;
            if (!gameState.l2.pastStrategies) gameState.l2.pastStrategies = [];
        } else {
            gameState = getDefaultGameState();
        }
    }

    function initGame() {
        loadGameState();
        ['l1', 'l2', 'l3'].forEach(level => {
             if (!gameState[level] || !gameState[level].stats || !gameState[level].stats.red) {
                resetStats(level);
             }
        });
        if (gameState.l2) gameState.l2.isRunning = false;
        if (gameState.l3) gameState.l3.isRunning = false;
    }
    
    function resetStats(level) {
        const statsTemplate = { score: 0, pops: 0, count: 0, pumps: 0 };
        gameState[level].stats = {
            red: {...statsTemplate},
            blue: {...statsTemplate},
            green: {...statsTemplate},
            yellow: {...statsTemplate}
        };
         gameState[level].strategy = {};
        if (level === 'l1') {
             gameState.l1.history = [];
             gameState.l1.balloonIndex = 0;
             gameState.l1.isPopping = false;
        }
        if (level === 'l2') {
            gameState.l2.processedCount = 0;
        }
         if (level === 'l3') {
            gameState.l3.totalScore = 0;
            gameState.l3.processedSinceChartUpdate = 0;
            gameState.l3.temperature = 20;
        }
    }

    // --- Utility Functions ---
    const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    
    // --- Custom Tooltip Functions ---
    function showTooltip(text, x, y) {
        customTooltip.textContent = text;
        customTooltip.style.left = x + 'px';
        customTooltip.style.top = y + 'px';
        customTooltip.style.opacity = '1';
        customTooltip.style.visibility = 'visible';
    }
    
    function hideTooltip() {
        customTooltip.style.opacity = '0';
        customTooltip.style.visibility = 'hidden';
    }
    
    function updateTooltipPosition(e) {
        if (customTooltip.style.visibility === 'visible') {
            customTooltip.style.left = e.clientX + 'px';
            customTooltip.style.top = e.clientY + 'px';
        }
    }
    
    // --- Cartoony Title Animations ---
    function animateTitlePage() {
        // Reset all elements to initial state
        mainTitle.style.opacity = '0';
        mainTitle.style.transform = 'scale(0) rotate(-10deg)';
        // Don't hide the subtitle - keep it visible
        // mainSubtitle.style.opacity = '0';
        // mainSubtitle.style.transform = 'translateY(50px)';
        mainDescription.style.opacity = '0';
        mainDescription.style.transform = 'translateY(30px)';
        
        // Trigger animations with delays
        setTimeout(() => {
            mainTitle.classList.add('title-bounce');
            // Ensure title is visible after animation
            setTimeout(() => {
                mainTitle.style.opacity = '1';
            }, 500);
        }, 100);
        
        // Skip subtitle animation to keep it visible
        // setTimeout(() => {
        //     mainSubtitle.classList.add('subtitle-slide');
        // }, 400);
        
        setTimeout(() => {
            mainDescription.classList.add('description-fade');
        }, 700);
        
        // Don't animate the button to avoid interfering with click functionality
        setTimeout(() => {
            mainDescription.style.opacity = '1';
            mainDescription.style.transform = 'translateY(0)';
        }, 1000);
    }
    
    const showScreen = (screenId) => {
        screens.forEach(s => s.classList.remove('active-screen'));
        document.getElementById(screenId).classList.add('active-screen');
        const isLevelScreen = screenId.startsWith('level-');
        const isLevelSelectScreen = screenId === 'level-select';
        homeBtn.style.display = isLevelScreen ? 'block' : 'none';
        helpBtn.style.display = (isLevelScreen && !isLevelSelectScreen) ? 'block' : 'none';
        
        // Trigger title page animation when showing main menu
        if (screenId === 'main-menu') {
            setTimeout(() => {
                animateTitlePage();
            }, 50);
        }
    };

    // --- Global Banner Update ---
    setInterval(() => {
        document.getElementById('global-red').textContent = parseInt(document.getElementById('global-red').textContent) + getRandomInt(1, 5);
        document.getElementById('global-blue').textContent = parseInt(document.getElementById('global-blue').textContent) + getRandomInt(0, 3);
        document.getElementById('global-green').textContent = parseInt(document.getElementById('global-green').textContent) + getRandomInt(0, 2);
        document.getElementById('global-gold').textContent = parseInt(document.getElementById('global-gold').textContent) + getRandomInt(0, 1);
    }, 2000);
    
    // --- Explosion Animation ---
    function createExplosion(container, color) {
        const PARTICLE_COUNT = 20;
        const colors = [BALLOON_CONFIG[color].chartColor, '#FFFFFF', '#FBBF24'];
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const angle = Math.random() * 2 * Math.PI;
            const distance = Math.random() * 70 + 30;
            const x = Math.cos(angle) * distance;
            const y = Math.sin(angle) * distance;
            particle.style.setProperty('--transform-end', `translate(${x}px, ${y}px)`);
            particle.style.background = colors[i % colors.length];
            container.appendChild(particle);
            setTimeout(() => {
                if (container.contains(particle)) {
                    container.removeChild(particle);
                }
            }, 700);
        }
    }
    
    // --- Tutorial System ---
    const tutorialHighlight = document.getElementById('tutorial-highlight');

    function showTutorialStep(steps, level) {
        const stepIndex = gameState.tutorial[level];
        if (stepIndex >= steps.length) {
            tutorialOverlay.style.display = 'none';
            return;
        }
        tutorialOverlay.style.display = 'block';

        const step = steps[stepIndex];
        const targetElement = document.querySelector(step.element);
        
        if (!targetElement) {
             gameState.tutorial[level]++;
             saveGameState();
             showTutorialStep(steps, level);
             return;
        }

        const rect = targetElement.getBoundingClientRect();

        tutorialHighlight.style.left = `${rect.left - 10}px`;
        tutorialHighlight.style.top = `${rect.top - 10}px`;
        tutorialHighlight.style.width = `${rect.width + 20}px`;
        tutorialHighlight.style.height = `${rect.height + 20}px`;

        document.getElementById('tutorial-title').textContent = step.title;
        const textContent = typeof step.text === 'function' ? step.text() : step.text;
        document.getElementById('tutorial-text').innerHTML = textContent;

        const boxWidth = 350; // max-width from CSS
        let boxLeft, boxTop;
        
        // Special positioning for certain tutorial steps
        if (step.title === 'Welcome to Training!' || step.title === 'You are ready to begin!') {
            // Center in the middle of the screen
            boxLeft = (window.innerWidth - boxWidth) / 2;
            boxTop = (window.innerHeight - 200) / 2; // 200px estimated height
        } else if (step.title === "AI's Short-Term Memory") {
            // Center the entire popup in the middle of the screen
            boxLeft = (window.innerWidth - boxWidth) / 2;
            boxTop = (window.innerHeight - 450) / 2; // Slightly higher position
        } else if (step.title === "Build Your AI!") {
            // Position to the right of the highlighting area
            boxLeft = rect.right + 20; // 20px to the right of the highlighted element
            boxTop = rect.top + (rect.height / 2) - 100; // Center vertically with highlighted element
        } else if (step.title === "Live Simulation") {
            // Position to the left of the highlighting area
            boxLeft = rect.left - boxWidth - 20; // 20px to the left of the highlighted element
            boxTop = rect.top + (rect.height / 2) - 100; // Center vertically with highlighted element
        } else {
            // Default positioning relative to target element
            boxLeft = rect.left + (rect.width / 2) - (boxWidth / 2);
            boxTop = rect.bottom + 20;
            
            // Check if box would go off bottom of screen
            if (boxTop + 200 > window.innerHeight) { // 200px estimated height
                boxTop = rect.top - 220; // Position above with some margin
            }
            
            // Check if box would go off top of screen
            if (boxTop < 20) {
                boxTop = 20; // Minimum top margin
            }
        }
        
        // Ensure box stays within horizontal bounds
        const finalLeft = Math.max(10, Math.min(window.innerWidth - boxWidth - 10, boxLeft));
        
        tutorialBox.style.top = `${boxTop}px`;
        tutorialBox.style.left = `${finalLeft}px`;
        
        tutorialPrevBtn.style.display = stepIndex === 0 ? 'none' : 'block';
        tutorialNextBtn.textContent = stepIndex === steps.length - 1 ? 'Finish' : 'Next';
    }


    
    function advanceTutorial(direction, steps, level) {
         gameState.tutorial[level] += direction;
         if(gameState.tutorial[level] < 0) gameState.tutorial[level] = 0;
         saveGameState();
         showTutorialStep(steps, level);
    }

    function skipTutorial() {
        const activeScreenId = document.querySelector('.active-screen').id;
        if (!activeScreenId.startsWith('level-')) return;
        const levelKey = 'l' + activeScreenId.slice(-1);
        
        // Mark tutorial as completed for this level
        const steps = levelKey === 'l1' ? L1_TUTORIAL_STEPS : levelKey === 'l2' ? L2_TUTORIAL_STEPS : L3_TUTORIAL_STEPS;
        gameState.tutorial[levelKey] = steps.length;
        saveGameState();
        
        // Hide tutorial overlay (skip button is part of overlay)
        tutorialOverlay.style.display = 'none';
    }

    const L1_TUTORIAL_STEPS = [
        { element: '#l1-game-area', title: 'Welcome to Training!', text: "Your goal is simple: PUMP the balloon to increase its value, but CASH OUT the score before it pops!"},
        { element: '#global-banner', title: 'Global Player Data', text: "Here's what players around the world are earning. This data might offer a clue... or it might show you a biased strategy. An AI must learn to evaluate if external data is useful or misleading. Should you trust it?"},
        { element: '#l1-data-panel', title: 'Your Personal Data', text: "As you play, your results will appear here. This is your AI's 'memory'. Use it to learn the balloon behaviors."},
        { element: '#l1-data-panel .text-red-400', title: '🎯 Pattern Recognition & Strategy Building', text: "After a few successful runs, the <strong>Avg. Pumps</strong> stat appears for each color. This is your personal data!<br><br><strong>Think about it:</strong> Do you notice patterns? Are some colors consistently allowing more pumps before popping? <br><br>This is how AI learns! By analyzing patterns in data, you can develop strategies. <br><br><em>💡 Pro tip: If Red balloons average 8 pumps safely, maybe try 7 pumps next time to be safer, or 9 pumps to be more aggressive!</em>"},
        { element: 'body', title: "AI's Short-Term Memory", text: "This panel shows your last 8 results. Think of this as an AI's <strong>Context Window</strong>. Like this panel, a GenAI model can only 'remember' a limited amount of recent information to make its next decision. Information that scrolls off is forgotten!<br><br><div class='mt-4 p-3 bg-indigo-800/50 rounded-lg'><div class='grid grid-cols-8 gap-2 justify-items-center text-center text-sm'><div class='w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-red-400 flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md' style='color: var(--tw-bg-red-400);'><span class='text-white'>7</span><span class='text-lg'>💰</span><div class='absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent' style='border-top-color: var(--tw-bg-red-400);'></div></div><div class='w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-blue-400 flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md' style='color: var(--tw-bg-blue-400);'><span class='text-white'>4</span><span class='text-lg'>💰</span><div class='absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent' style='border-top-color: var(--tw-bg-blue-400);'></div></div><div class='w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-green-400 flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md' style='color: var(--tw-bg-green-400);'><span class='text-white'>3</span><span class='text-lg'>💥</span><div class='absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent' style='border-top-color: var(--tw-bg-green-400);'></div></div><div class='w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-red-400 flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md' style='color: var(--tw-bg-red-400);'><span class='text-white'>9</span><span class='text-lg'>💰</span><div class='absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent' style='border-top-color: var(--tw-bg-red-400);'></div></div><div class='w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-blue-400 flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md' style='color: var(--tw-bg-blue-400);'><span class='text-white'>5</span><span class='text-lg'>💰</span><div class='absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent' style='border-top-color: var(--tw-bg-blue-400);'></div></div><div class='w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-green-400 flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md' style='color: var(--tw-bg-green-400);'><span class='text-white'>6</span><span class='text-lg'>💥</span><div class='absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent' style='border-top-color: var(--tw-bg-green-400);'></div></div><div class='w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-red-400 flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md' style='color: var(--tw-bg-red-400);'><span class='text-white'>8</span><span class='text-lg'>💰</span><div class='absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent' style='border-top-color: var(--tw-bg-red-400);'></div></div><div class='w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-blue-400 flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md' style='color: var(--tw-bg-blue-400);'><span class='text-white'>3</span><span class='text-lg'>💰</span><div class='absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent' style='border-top-color: var(--tw-bg-blue-400);'></div></div></div><p class='text-xs text-indigo-300 mt-2'>Example: Last 8 balloon results (💰 = cashed out, 💥 = popped)</p></div>"},
        { element: '#l1-data-panel .text-green-400', title: 'Noisy Data!', text: "Watch out! Green balloons are highly unpredictable. In AI, this is called 'noisy data', and it's very difficult to make accurate predictions from it."},
        { element: 'body', title: 'You are ready to begin!', text: "You've learned the basics! Time to test your knowledge. Good luck!"},
    ];
     const L2_TUTORIAL_STEPS = [
        { element: '#l2-control-panel', title: 'Build Your AI!', text: "Now you're the teacher. Use the sliders to set rules for your AI based on what you learned in Level 1. The AI will automatically cash in after this many pumps of each balloon type."},
        { element: 'body', title: 'AI Insights', text: "This section will show you real-time insights about your AI's performance. Watch for patterns and learn from the data to improve your strategy!"},
        { element: '#l2-simulation-panel', title: 'Live Simulation', text: "Your AI will now process 100 balloons based on your rules. Watch the performance monitor to see how it performs."},
        { element: '#l2-start-stop-btn', title: 'Human-in-the-Loop', text: "Things not going well? You can PAUSE the simulation at any time to adjust your AI's rules. This is your role as a Human Supervisor!"},
    ];
    
    const L3_TUTORIAL_STEPS = [
        { element: '#level-3 .bg-gradient-to-br', title: '🌡️ AI Temperature Control', text: "Welcome to the Production Floor! Here you'll learn about <strong>AI Temperature</strong> - one of the most important concepts in modern AI. Temperature controls how 'creative' or 'conservative' your AI behaves."},
        { element: '#l3-temp-display', title: 'Temperature Display', text: "This shows the current factory temperature. In AI terms, <strong>low temperature = stable, predictable behavior</strong> while <strong>high temperature = creative, risky behavior</strong>. Watch how it affects balloon stability!"},
        { element: '#l3-start-stop-btn', title: '🚀 Start Production', text: "Click this to begin continuous balloon production. Your AI will process balloons forever, but the weather will change every 15-60 seconds, affecting balloon behavior!"},
        { element: 'body', title: '🌤️ Weather Patterns', text: "Notice the weather effects? <strong>Hot weather = balloons pop easier</strong> (high temperature = risky AI). <strong>Cold weather = balloons more stable</strong> (low temperature = conservative AI). This is exactly how AI temperature works!"},
        { element: 'body', title: '🎯 Pattern Recognition', text: "As you play, ask yourself: <strong>Do you notice the tendency of balloons to pop more in hot weather?</strong> This is the key insight - temperature directly affects AI behavior and decision-making!"},
        { element: 'body', title: '🤖 AI Temperature in Real Life', text: "In real AI systems, temperature controls creativity vs stability. <strong>Low temp (0.1-0.3):</strong> Conservative, factual responses. <strong>High temp (0.7-1.0):</strong> Creative, varied responses. Your balloon factory simulates this perfectly!"},
        { element: 'body', title: '🎮 Your Mission', text: "Adapt your pump settings based on the weather! When it's hot, reduce pumps to avoid losses. When it's cold, increase pumps for higher profits. This teaches you to tune AI temperature for optimal performance!"},
    ];

    // --- Navigation ---
    function goToLevelSelect() {
        showScreen('level-select');
    }

    function setInsight(text, level) {
        const insightEl = document.getElementById(`l${level}-insights`);
        if (!insightEl) return;
        insightEl.style.opacity = '0';
        setTimeout(() => {
            insightEl.innerHTML = text;
            insightEl.style.opacity = '1';
        }, 300);
    }
    
    // =================================
    // ========= LEVEL 1 LOGIC =========
    // =================================
    const l1PumpBtn = document.getElementById('l1-pump-btn');
    const l1BankBtn = document.getElementById('l1-bank-btn');
    const l1BalloonArea = document.getElementById('l1-balloon-area');

    function startLevel1() {
        showScreen('level-1');
        document.getElementById('l1-insights-title').textContent = "AI Insights";
        if (gameState.l1.balloonIndex >= L1_SEQUENCE.length) {
            endLevel1(true); 
        } else {
            document.getElementById('l1-controls').style.display = 'flex';
            document.getElementById('l1-summary-area').style.display = 'none';
            l1BalloonArea.style.display = 'flex';
            document.getElementById('l1-progress').style.display = 'block';
            setupNextL1Balloon();
            showTutorialStep(L1_TUTORIAL_STEPS, 'l1');
        }
    }
    
    function replayLevel1() {
        resetStats('l1');
        gameState.tutorial.l1 = 0;
        saveGameState();
        startLevel1();
    }

    function setupNextL1Balloon() {
        gameState.l1.isPopping = false;
        if (gameState.l1.balloonIndex >= L1_SEQUENCE.length) { endLevel1(); return; }
        const type = L1_SEQUENCE[gameState.l1.balloonIndex];
        gameState.l1.currentBalloon = { type: type, maxPumps: getRandomInt(...BALLOON_CONFIG[type].range), colorClass: BALLOON_CONFIG[type].color };
        gameState.l1.currentPumps = 0;
        renderL1();

        const index = gameState.l1.balloonIndex;
        if (index === 0) setInsight("Every pump adds to the score, but also risk. How far will you push it?", 1);
        else if (index === 4) setInsight("You've seen a few red balloons now. Have you developed a strategy? 🤔", 1);
        else if (index === 8) setInsight("The data is changing. A good AI must adapt its strategy constantly.", 1);
        else if (index === 12) setInsight("Trusting the global data can be misleading. What does YOUR data tell you?", 1);
        
        if(gameState.tutorial.l1 === 5 && type === 'green') showTutorialStep(L1_TUTORIAL_STEPS, 'l1');
    }
    
    function renderL1() {
        const { currentBalloon, currentPumps } = gameState.l1;
        const scale = 1 + currentPumps * 0.08;
        l1BalloonArea.innerHTML = `<div class="balloon bg-${currentBalloon.colorClass}" style="--scale: ${scale}; transform: scale(${scale}); color: var(--tw-bg-${currentBalloon.colorClass})"><div class="balloon-face"><div class="eye left" style="transform: scaleY(${1 + currentPumps * 0.05})"></div><div class="eye right" style="transform: scaleY(${1 + currentPumps * 0.05})"></div><div class="mouth"></div></div><div class="balloon-string"></div></div>`;
        document.getElementById('l1-progress').textContent = `Balloon ${gameState.l1.balloonIndex + 1} of ${L1_SEQUENCE.length}`;
        document.getElementById('l1-current-score').textContent = currentPumps;
        
        Object.keys(gameState.l1.stats).forEach(color => {
            if (document.getElementById(`l1-${color}-score`)) {
                const stat = gameState.l1.stats[color] || { score: 0, pumps: 0, count: 0};
                document.getElementById(`l1-${color}-score`).textContent = `$${stat.score}`;
                const avg = stat.count > 0 ? (stat.pumps / stat.count).toFixed(1) : '0.0';
                document.getElementById(`l1-${color}-avg`).textContent = avg;
            }
        });

        const historyEl = document.getElementById('l1-history');
        historyEl.innerHTML = (gameState.l1.history || []).map(h => {
            const colorClass = BALLOON_CONFIG[h.type].color;
            const popClass = h.popped ? 'opacity-60' : '';
            return `<div class="w-12 h-14 rounded-[50%/60%_60%_40%_40%] bg-${colorClass} ${popClass} flex flex-col items-center justify-center text-white font-bold text-xs relative shadow-md" style="color: var(--tw-bg-${colorClass});"><span class="text-white">${h.pumps}</span><span class="text-lg">${h.popped ? '💥' : '💰'}</span><div class="absolute bottom-[-4px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-6 border-l-transparent border-r-transparent" style="border-top-color: var(--tw-bg-${colorClass});"></div></div>`;
        }).join('');
    }

    function handleL1Pump() {
        if (gameState.l1.isPopping) return;
        const balloonEl = l1BalloonArea.querySelector('.balloon');
        if (balloonEl) { balloonEl.classList.remove('pump-jiggle'); void balloonEl.offsetWidth; balloonEl.classList.add('pump-jiggle'); }
        gameState.l1.currentPumps++;
        if (gameState.l1.currentPumps > gameState.l1.currentBalloon.maxPumps) { handleL1Pop(); } else { renderL1(); }
    }

    function handleL1Bank() {
        if (gameState.l1.isPopping) return;
        const { type } = gameState.l1.currentBalloon;
        const pumps = gameState.l1.currentPumps;
        gameState.l1.stats[type].score += pumps;
        gameState.l1.stats[type].pumps += pumps;
        gameState.l1.stats[type].count++;
        addToL1History(type, pumps, false);
        gameState.l1.balloonIndex++;
        saveGameState();
        
        if (gameState.tutorial.l1 <= 2) showTutorialStep(L1_TUTORIAL_STEPS, 'l1');
        if (gameState.tutorial.l1 === 3 && gameState.l1.stats.red.count > 1) {
             showTutorialStep(L1_TUTORIAL_STEPS, 'l1');
        }
        setupNextL1Balloon();
    }
    
    function handleL1Pop() {
        gameState.l1.isPopping = true;
        const { type, maxPumps } = gameState.l1.currentBalloon;
        const balloonEl = l1BalloonArea.querySelector('.balloon');
        if (balloonEl) { createExplosion(l1BalloonArea, type); balloonEl.style.display = 'none'; }
        gameState.l1.stats[type].count++;
        addToL1History(type, maxPumps, true);
        saveGameState();
        setTimeout(() => { gameState.l1.balloonIndex++; setupNextL1Balloon(); }, 500);
    }

    function addToL1History(type, pumps, popped) {
        if(!gameState.l1.history) gameState.l1.history = [];
        gameState.l1.history.unshift({ type, pumps, popped });
        if (gameState.l1.history.length > 8) gameState.l1.history.pop();
        if (gameState.tutorial.l1 === 4) showTutorialStep(L1_TUTORIAL_STEPS, 'l1');
    }

    function endLevel1(isReview = false) {
        let totalScore = 0;
        if (!isReview) {
            gameState.unlockedLevels = Math.max(gameState.unlockedLevels, 2);
            totalScore = Object.values(gameState.l1.stats).reduce((sum, s) => sum + s.score, 0);
            if (totalScore > (gameState.l1.bestScore || 0)) {
                gameState.l1.bestScore = totalScore;
            }
            saveGameState();
        }
        
        totalScore = Object.values(gameState.l1.stats).reduce((sum, s) => sum + s.score, 0);
        const isNewBest = totalScore === gameState.l1.bestScore && !isReview;

        renderL1();
        l1BalloonArea.style.display = 'none';
        document.getElementById('l1-progress').style.display = 'none';
        document.getElementById('l1-controls').style.display = 'none';
        
        document.getElementById('l1-score-summary').innerHTML = `
            <p class="text-2xl font-semibold text-indigo-200">YOU EARNED</p>
            <p class="text-6xl font-bold text-yellow-300 my-2">$${totalScore}</p>
            <p class="text-lg font-semibold ${isNewBest ? 'text-green-400' : 'text-indigo-300'}">
                ${isNewBest ? 'New Best Score!' : `Best Score: $${gameState.l1.bestScore}`}
            </p>
        `;

        document.getElementById('l1-summary-area').style.display = 'block';
        document.getElementById('l1-insights-title').textContent = "Final Data Insights";
        setInsight(`<div class="text-left text-sm space-y-1">
                <p><strong><span class="text-red-400">Red:</span></strong> High risk, high reward. A tempting but dangerous choice.</p>
                <p><strong><span class="text-blue-400">Blue:</span></strong> Very predictable. Low risk, but the profits are smaller.</p>
                <p><strong><span class="text-green-400">Green:</span></strong> Highly unpredictable 'noisy data'. It's tough to form a reliable strategy here.</p>
            </div>`, 1);
        renderEducationalSlides('l1', 0);
    }
    
    // --- Educational Slides ---
    const EDUCATIONAL_SLIDES = {
        l1: [
            { title: "You Are The AI!", text: "You just performed <strong>Pattern Recognition</strong>. By observing data (balloons popping), your brain created a mental model to predict future outcomes. This is the fundamental concept behind most AI systems!" },
            { title: "Beware of Bias!", text: "Did the first four Red balloons make you feel overconfident? This is a form of <strong>Selection Bias</strong>, where early data skews your model. An AI trained only on this data might make dangerously risky decisions." },
            { title: "Handling 'Noisy' Data", text: "Green balloons were chaotic, right? This represents <strong>'Noisy Data'</strong> in AI. It's difficult to find a reliable pattern in noisy data, which can lead to poor predictions and overfitting." }
        ]
    };
    
    let currentSlideIndex = 0;
    function renderEducationalSlides(level, index) {
        currentSlideIndex = index;
        const slides = EDUCATIONAL_SLIDES[level];
        const slide = slides[index];
        const contentEl = document.getElementById('slide-content');
        contentEl.innerHTML = `<h3 class="text-2xl font-bold mb-2">${slide.title}</h3><p class="text-indigo-200">${slide.text}</p>`;
        document.getElementById('slide-indicator').textContent = `${index + 1} / ${slides.length}`;
        document.getElementById('prev-slide-btn').disabled = index === 0;
        document.getElementById('next-slide-btn').disabled = index === slides.length - 1;
    }
    
    // =================================
    // ========= LEVEL 2 LOGIC =========
    // =================================
    const l2StartStopBtn = document.getElementById('l2-start-stop-btn');
    const conveyor2 = document.getElementById('l2-conveyor');
    const l2OpenGameBtn = document.getElementById('l2-open-game-btn');
    const l2CompletionModal = document.getElementById('l2-completion-modal');
    const l2ModalCloseBtn = document.getElementById('l2-modal-close');

    function startLevel2() {
        showScreen('level-2');
        if (gameState.l2.processedCount >= 100) {
            endLevel2(true);
        } else {
            buildPerformanceMonitor('l2');
            updateL2Stats();
            displayPastStrategies(); // Show past strategies
            showTutorialStep(L2_TUTORIAL_STEPS, 'l2');
        }
    }
    
    function replayLevel2() {
        resetStats('l2');
        gameState.tutorial.l2 = 0;
        saveGameState();
        startLevel2();
    }
    
    function buildPerformanceMonitor(level) {
        const monitorEl = document.getElementById(`${level}-performance-monitor`);
        if(!monitorEl) return;
        monitorEl.innerHTML = Object.keys(BALLOON_CONFIG).map(color => `
            <div>
                <div class="flex justify-between items-baseline mb-1">
                    <span class="font-bold text-${BALLOON_CONFIG[color].color}">${color.charAt(0).toUpperCase() + color.slice(1)}</span>
                    <div class="text-right">
                        <span id="${level}-${color}-avg-score" class="font-mono text-lg">$0.0</span>
                        <span class="text-xs text-indigo-300 block">Avg. Score</span>
                    </div>
                    <div class="text-right">
                        <span id="${level}-${color}-pop-rate" class="font-mono text-lg">0%</span>
                         <span class="text-xs text-indigo-300 block">Pop Rate</span>
                    </div>
                </div>
                <div class="performance-bar"><div id="${level}-${color}-perf-bar" class="performance-bar-inner"></div></div>
            </div>
        `).join('');
    }

    function updatePerformanceMonitor(level) {
         Object.keys(BALLOON_CONFIG).forEach(color => {
            const stats = gameState[level].stats[color];
            const avgScore = stats.count > 0 ? (stats.score / stats.count) : 0;
            const popRate = stats.count > 0 ? (stats.pops / stats.count) * 100 : 0;
            
            document.getElementById(`${level}-${color}-avg-score`).textContent = `$${avgScore.toFixed(1)}`;
            document.getElementById(`${level}-${color}-pop-rate`).textContent = `${popRate.toFixed(0)}%`;
            
            const bar = document.getElementById(`${level}-${color}-perf-bar`);
            const maxAvg = BALLOON_CONFIG[color].range[1];
            const perfPercent = Math.min(100, (avgScore / maxAvg) * 100);

            bar.style.width = `${perfPercent}%`;
            // Use balloon colors instead of performance colors
            if (color === 'red') {
                bar.className = 'performance-bar-inner bg-red-500';
            } else if (color === 'blue') {
                bar.className = 'performance-bar-inner bg-blue-400';
            } else if (color === 'green') {
                bar.className = 'performance-bar-inner bg-green-400';
            } else if (color === 'yellow') {
                bar.className = 'performance-bar-inner bg-yellow-400';
            }
         });
    }

    function setupL2Controls() { ['red', 'blue', 'green', 'yellow'].forEach(color => { const slider = document.getElementById(`l2-${color}-pumps`); const valSpan = document.getElementById(`l2-${color}-val`); slider.addEventListener('input', () => { valSpan.textContent = slider.value; if (!gameState.l2.isRunning) updateL2Strategy(); }); }); }
    function updateL2Strategy() { ['red', 'blue', 'green', 'yellow'].forEach(color => { gameState.l2.strategy[color] = parseInt(document.getElementById(`l2-${color}-pumps`).value); }); }
    
    function disableL2Sliders() {
        ['red', 'blue', 'green', 'yellow'].forEach(color => {
            const slider = document.getElementById(`l2-${color}-pumps`);
            slider.disabled = true;
            slider.style.opacity = '0.5';
            slider.style.cursor = 'not-allowed';
        });
    }
    
    function enableL2Sliders() {
        ['red', 'blue', 'green', 'yellow'].forEach(color => {
            const slider = document.getElementById(`l2-${color}-pumps`);
            slider.disabled = false;
            slider.style.opacity = '1';
            slider.style.cursor = 'pointer';
        });
    }
    
    function resetL2Simulation() {
        // Reset processed count
        gameState.l2.processedCount = 0;
        
        // Reset earned amount
        gameState.l2.totalEarned = 0;
        document.getElementById('l2-earned-amount').textContent = '0';
        
        // Reset stats
        const statsTemplate = { score: 0, pops: 0, count: 0, pumps: 0 };
        gameState.l2.stats = {
            red: {...statsTemplate},
            blue: {...statsTemplate},
            green: {...statsTemplate},
            yellow: {...statsTemplate}
        };
        
        // Clear conveyor belt
        const conveyor2 = document.getElementById('l2-conveyor');
        if (conveyor2) {
            conveyor2.innerHTML = '';
        }
        
        // Update display
        updateL2Stats();
        updatePerformanceMonitor('l2');
    }
    
    function saveL2Strategy() {
        // Calculate performance summary
        const performance = {};
        let totalScore = 0;
        let totalPops = 0;
        let totalCount = 0;
        
        ['red', 'blue', 'green', 'yellow'].forEach(color => {
            const stats = gameState.l2.stats[color];
            const avgScore = stats.count > 0 ? (stats.score / stats.count) : 0;
            const popRate = stats.count > 0 ? (stats.pops / stats.count) * 100 : 0;
            
            performance[color] = {
                avgScore: avgScore,
                popRate: popRate,
                count: stats.count
            };
            
            totalScore += stats.score;
            totalPops += stats.pops;
            totalCount += stats.count;
        });
        
        const overallPopRate = totalCount > 0 ? (totalPops / totalCount) * 100 : 0;
        const overallAvgScore = totalCount > 0 ? totalScore / totalCount : 0;
        
        // Create strategy record
        const strategyRecord = {
            timestamp: Date.now(),
            strategy: { ...gameState.l2.strategy },
            performance: performance,
            overallPopRate: overallPopRate,
            overallAvgScore: overallAvgScore,
            totalProcessed: gameState.l2.processedCount
        };
        
        // Add to past strategies (keep only last 3)
        if (!gameState.l2.pastStrategies) {
            gameState.l2.pastStrategies = [];
        }
        gameState.l2.pastStrategies.unshift(strategyRecord);
        if (gameState.l2.pastStrategies.length > 3) {
            gameState.l2.pastStrategies = gameState.l2.pastStrategies.slice(0, 3);
        }
        
        // Save to localStorage
        saveGameState();
        
        // Update display
        displayPastStrategies();
    }
    
    function displayPastStrategies() {
        const strategiesList = document.getElementById('l2-strategies-list');
        if (!strategiesList || !gameState.l2.pastStrategies) return;
        
        if (gameState.l2.pastStrategies.length === 0) {
            strategiesList.innerHTML = `
                <div class="bg-indigo-900/20 p-4 rounded-lg border border-indigo-600 min-w-[320px] flex-shrink-0 flex flex-col justify-center" style="min-height: 200px;">
                    <div class="text-center">
                        <div class="text-indigo-400 text-sm mb-2">No strategies yet</div>
                        <div class="text-xs text-indigo-500">Run a test to see your strategies here</div>
                    </div>
                </div>
            `;
            return;
        }
        
        strategiesList.innerHTML = gameState.l2.pastStrategies.map((strategy, index) => {
            const strategyNum = gameState.l2.pastStrategies.length - index;
            const timeAgo = Math.round((Date.now() - strategy.timestamp) / 1000);
            
            return `
                <div class="bg-indigo-900/30 p-4 rounded-lg border border-indigo-600 min-w-[320px] flex-shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-sm font-bold text-indigo-200">Strategy ${strategyNum}</span>
                    <button class="delete-strategy-btn text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 px-2 py-1 rounded transition" data-index="${index}">
                        ×
                    </button>
                </div>
                    
                    <!-- Strategy Settings -->
                    <div class="mb-3">
                        <div class="text-xs font-bold text-indigo-300 mb-2">Your Strategy:</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            ${['red', 'blue', 'green', 'yellow'].map(color => `
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-1">
                                        <div class="w-2 h-2 rounded-full bg-${color}-400"></div>
                                        <span class="text-${color}-400 font-bold">${color.toUpperCase()}:</span>
                                    </div>
                                    <span class="text-white font-mono">${strategy.strategy[color] || 0} pumps</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Performance Data by Color -->
                    <div class="mb-3">
                        <div class="text-xs font-bold text-indigo-300 mb-2">Pop Rates by Color:</div>
                        <div class="space-y-1 text-xs">
                            ${['red', 'blue', 'green', 'yellow'].map(color => `
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-1">
                                        <div class="w-2 h-2 rounded-full bg-${color}-400"></div>
                                        <span class="text-${color}-400">${color.toUpperCase()}:</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="text-white">${strategy.performance[color].count} balloons</span>
                                        <span class="text-red-400 font-bold">${strategy.performance[color].popRate.toFixed(0)}%</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Overall Summary -->
                    <div class="pt-2 border-t border-indigo-600 text-xs">
                        <div class="flex justify-between mb-1">
                            <span class="text-indigo-300">Overall Pop Rate:</span>
                            <span class="text-red-400 font-bold">${strategy.overallPopRate.toFixed(0)}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-indigo-300">Total Earned:</span>
                            <span class="text-green-400 font-bold">$${strategy.overallAvgScore * strategy.totalProcessed}</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Add event listeners for delete buttons
        strategiesList.querySelectorAll('.delete-strategy-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.getAttribute('data-index'));
                deleteL2Strategy(index);
            });
        });
    }
    
    function deleteL2Strategy(index) {
        if (index >= 0 && index < gameState.l2.pastStrategies.length) {
            gameState.l2.pastStrategies.splice(index, 1);
            saveGameState();
            displayPastStrategies();
        }
    }
    
    function clearAllL2Strategies() {
        gameState.l2.pastStrategies = [];
        saveGameState();
        displayPastStrategies();
    }
    
    function skipL2ToEnd() {
        if (!gameState.l2.isRunning) return;
        
        // Stop the current simulation
        clearInterval(gameState.l2.interval);
        
        // Simulate processing remaining balloons instantly
        const remaining = 100 - gameState.l2.processedCount;
        for (let i = 0; i < remaining; i++) {
            const color = getL2RandomBalloon();
            const config = BALLOON_CONFIG[color];
            const maxPumps = getRandomInt(...config.range);
            const strategyPumps = gameState.l2.strategy[color];
            
            // Calculate if balloon pops (same logic as normal simulation)
            let scoreVal = 0;
            if (strategyPumps > maxPumps) {
                gameState.l2.stats[color].pops++;
            } else {
                scoreVal = strategyPumps;
                gameState.l2.stats[color].score += scoreVal;
            }
            
            // Update stats
            gameState.l2.stats[color].count++;
            gameState.l2.processedCount++;
            
            // Update earned amount
            gameState.l2.totalEarned = (gameState.l2.totalEarned || 0) + scoreVal;
        }
        
        // Update display
        updateL2Stats();
        document.getElementById('l2-earned-amount').textContent = gameState.l2.totalEarned;
        
        // Save the strategy
        saveL2Strategy();
        
        // Small delay to ensure performance monitor updates are visible
        setTimeout(() => {
            endLevel2(true);
        }, 100);
    }

    function toggleL2Simulation() {
        gameState.l2.isRunning = !gameState.l2.isRunning;
        const skipBtn = document.getElementById('l2-skip-to-end-btn');
        
        if (gameState.l2.isRunning) {
            if (gameState.tutorial.l2 < L2_TUTORIAL_STEPS.length) showTutorialStep(L2_TUTORIAL_STEPS, 'l2');
            l2StartStopBtn.textContent = 'FINISH TEST';
            l2StartStopBtn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
            l2StartStopBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            updateL2Strategy();
            disableL2Sliders();
            resetL2Simulation(); // Reset when starting
            runL2Simulation();
            skipBtn.classList.remove('hidden'); // Show skip button
        } else {
            if (gameState.tutorial.l2 < L2_TUTORIAL_STEPS.length) showTutorialStep(L2_TUTORIAL_STEPS, 'l2');
            l2StartStopBtn.textContent = 'RUN TEST';
            l2StartStopBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
            l2StartStopBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            enableL2Sliders();
            saveL2Strategy(); // Save strategy when pausing
            clearInterval(gameState.l2.interval);
            skipBtn.classList.add('hidden'); // Hide skip button when paused
        }
    }

    function getL2RandomBalloon() { const rand = Math.random(); if (rand < 0.3) return 'red'; if (rand < 0.6) return 'blue'; if (rand < 0.8) return 'green'; return 'yellow'; }

    function runL2Simulation() {
        gameState.l2.interval = setInterval(() => {
            if (gameState.l2.processedCount >= 100) { endLevel2(); return; }
            const type = getL2RandomBalloon();
            const config = BALLOON_CONFIG[type];
            const maxPumps = getRandomInt(...config.range);
            const strategyPumps = gameState.l2.strategy[type];
            let scoreVal = 0;
            if (strategyPumps > maxPumps) { gameState.l2.stats[type].pops++; } else { scoreVal = strategyPumps; gameState.l2.stats[type].score += scoreVal; }
            gameState.l2.stats[type].count++; gameState.l2.processedCount++;
            
            // Update earned amount
            gameState.l2.totalEarned = (gameState.l2.totalEarned || 0) + scoreVal;
            document.getElementById('l2-earned-amount').textContent = gameState.l2.totalEarned;
            const balloonItem = document.createElement('div');
            balloonItem.className = 'absolute top-1/2 left-1/2 conveyor-belt-item';
            const balloonEl = document.createElement('div');
            balloonEl.className = `balloon bg-${config.color}`;
            balloonEl.style.transform = 'scale(0.5)';
            balloonEl.style.color = `var(--tw-bg-${config.color})`;
            balloonItem.appendChild(balloonEl);
            if (scoreVal === 0) { 
                setTimeout(() => { 
                    balloonEl.classList.add('pre-explode');
                    setTimeout(() => { 
                        createExplosion(balloonItem, type); 
                        balloonEl.style.display = 'none'; 
                    }, 500);
                }, 1500); 
            }
            conveyor2.appendChild(balloonItem);
            setTimeout(() => { if (conveyor2.contains(balloonItem)) conveyor2.removeChild(balloonItem); }, 4000);
            updateL2Stats();
            if (gameState.l2.processedCount === 25) setInsight("Your model is running. Are the pop rates acceptable? Pause and adjust!", 2);
            if (gameState.l2.processedCount === 60) setInsight("The performance monitor gives you live feedback. Are any of your strategies unprofitable?", 2);
        }, 400); // Slower pace
    }

    function updateL2Stats() {
        document.getElementById('l2-processed-count').textContent = gameState.l2.processedCount;
        updatePerformanceMonitor('l2');
    }

    function endLevel2(isReview = false) {
        if (!isReview) {
            clearInterval(gameState.l2.interval);
            gameState.l2.isRunning = false;
            gameState.unlockedLevels = Math.max(gameState.unlockedLevels, 3);
            saveGameState();
        }
        updateL2Stats();
        
        // Reset button to RUN TEST state
        l2StartStopBtn.textContent = 'RUN TEST';
        l2StartStopBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
        l2StartStopBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
        enableL2Sliders();
        
        // Show completion modal instead of summary area
        l2CompletionModal.classList.remove('hidden');
    }
    
    // =================================
    // ========= LEVEL 3 LOGIC =========
    // =================================
    const l3StartStopBtn = document.getElementById('l3-start-stop-btn');
    const l3Conveyor = document.getElementById('l3-conveyor');
    const l3TempDisplay = document.getElementById('l3-temp-display');
    
    function startLevel3() {
        showScreen('level-3');
        updateL3Strategy();
        buildPerformanceMonitor('l3');
        updateL3Stats();
        updateWeatherDisplay();
        showTutorialStep(L3_TUTORIAL_STEPS, 'l3');
    }
    
    function setupL3Controls() { ['red', 'blue', 'green', 'yellow'].forEach(color => { const slider = document.getElementById(`l3-${color}-pumps`); const valSpan = document.getElementById(`l3-${color}-val`); slider.addEventListener('input', () => { valSpan.textContent = slider.value; updateL3Strategy(); }); }); }
    function updateL3Strategy() { ['red', 'blue', 'green', 'yellow'].forEach(color => { gameState.l3.strategy[color] = parseInt(document.getElementById(`l3-${color}-pumps`).value); }); }

    function toggleL3Simulation() {
        gameState.l3.isRunning = !gameState.l3.isRunning;
        if (gameState.l3.isRunning) {
            l3StartStopBtn.textContent = '⏸️ PAUSE PRODUCTION';
            l3StartStopBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            l3StartStopBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
            runL3Simulation();
            runL3TempChanges();
        } else {
            l3StartStopBtn.textContent = '🚀 START PRODUCTION';
            l3StartStopBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            l3StartStopBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
            clearInterval(gameState.l3.interval);
            clearTimeout(gameState.l3.tempInterval);
            hideWeatherEffects();
        }
    }
    
    function updateWeatherDisplay() {
        const temp = gameState.l3.temperature;
        const weatherIcon = document.getElementById('weather-icon');
        const weatherStatus = document.getElementById('weather-status');
        const tempBar = document.getElementById('temp-bar');
        
        // Update temperature display
        l3TempDisplay.textContent = `${temp}°C`;
        
        // Update weather icon and status with more dramatic conditions
        if (temp > 35) {
            weatherIcon.innerHTML = '🔥<div class="sun-effect" style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: radial-gradient(circle, #FFD700, #FF8C00); border-radius: 50%; opacity: 0.9; animation: sunPulse 2s ease-in-out infinite;"></div>';
            weatherStatus.textContent = 'EXTREME HEAT - CRITICAL RISK';
            l3TempDisplay.className = 'text-4xl font-black transition-all duration-1000 mb-2 text-red-600 animate-pulse';
            tempBar.style.width = '100%';
            tempBar.className = 'h-full bg-gradient-to-r from-red-500 to-red-700 transition-all duration-1000';
            showWeatherEffect('extreme-heat');
        } else if (temp > 30) {
            weatherIcon.innerHTML = '🌡️<div class="sun-effect" style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; background: radial-gradient(circle, #FFA500, #FF6347); border-radius: 50%; opacity: 0.8; animation: sunPulse 2.5s ease-in-out infinite;"></div>';
            weatherStatus.textContent = 'Heat Wave - HIGH RISK';
            l3TempDisplay.className = 'text-4xl font-black transition-all duration-1000 mb-2 text-red-500';
            tempBar.style.width = '90%';
            tempBar.className = 'h-full bg-gradient-to-r from-yellow-400 to-red-500 transition-all duration-1000';
            showWeatherEffect('heat');
        } else if (temp > 25) {
            weatherIcon.innerHTML = '☀️<div class="sun-effect" style="position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 40px; height: 40px; background: radial-gradient(circle, #FFE135, #FFA500); border-radius: 50%; opacity: 0.7; animation: sunPulse 3s ease-in-out infinite;"></div>';
            weatherStatus.textContent = 'Warm - Moderate Risk';
            l3TempDisplay.className = 'text-4xl font-black transition-all duration-1000 mb-2 text-orange-400';
            tempBar.style.width = '70%';
            tempBar.className = 'h-full bg-gradient-to-r from-orange-400 to-red-400 transition-all duration-1000';
            hideWeatherEffects();
        } else if (temp < 5) {
            weatherIcon.textContent = '🧊';
            weatherStatus.textContent = 'BLIZZARD - EXTREME COLD';
            l3TempDisplay.className = 'text-4xl font-black transition-all duration-1000 mb-2 text-blue-600 animate-pulse';
            tempBar.style.width = '10%';
            tempBar.className = 'h-full bg-gradient-to-r from-blue-600 to-blue-800 transition-all duration-1000';
            showWeatherEffect('blizzard');
        } else if (temp < 10) {
            weatherIcon.textContent = '❄️';
            weatherStatus.textContent = 'Cold Snap - Low Risk';
            l3TempDisplay.className = 'text-4xl font-black transition-all duration-1000 mb-2 text-blue-400';
            tempBar.style.width = '20%';
            tempBar.className = 'h-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-1000';
            showWeatherEffect('snow');
        } else if (temp < 15) {
            weatherIcon.textContent = '⛈️';
            weatherStatus.textContent = 'Storm - Unstable Conditions';
            l3TempDisplay.className = 'text-4xl font-black transition-all duration-1000 mb-2 text-purple-400';
            tempBar.style.width = '30%';
            tempBar.className = 'h-full bg-gradient-to-r from-purple-400 to-blue-500 transition-all duration-1000';
            showWeatherEffect('storm');
        } else if (temp < 20) {
            weatherIcon.textContent = '🌧️';
            weatherStatus.textContent = 'Cool - Stable Conditions';
            l3TempDisplay.className = 'text-4xl font-black transition-all duration-1000 mb-2 text-blue-300';
            tempBar.style.width = '40%';
            tempBar.className = 'h-full bg-gradient-to-r from-blue-400 to-blue-500 transition-all duration-1000';
            showWeatherEffect('rain');
        } else {
            weatherIcon.textContent = '🌤️';
            weatherStatus.textContent = 'Perfect Conditions';
            l3TempDisplay.className = 'text-4xl font-black transition-all duration-1000 mb-2 text-green-400';
            tempBar.style.width = '50%';
            tempBar.className = 'h-full bg-gradient-to-r from-green-400 to-blue-400 transition-all duration-1000';
            hideWeatherEffects();
        }
    }
    
    function showWeatherEffect(type) {
        hideWeatherEffects();
        const container = document.getElementById('weather-effects');
        let effectDiv;
        
        // Determine which effect container to use
        if (type === 'extreme-heat' || type === 'heat') {
            effectDiv = document.getElementById('heat-waves');
        } else if (type === 'blizzard' || type === 'snow') {
            effectDiv = document.getElementById('snow-flakes');
        } else if (type === 'storm' || type === 'rain') {
            effectDiv = document.getElementById('rain-drops');
        }
        
        effectDiv.classList.remove('hidden');
        
        // Start continuous weather animation
        startContinuousWeatherEffect(type, effectDiv);
        
    }
    
    function hideWeatherEffects() {
        document.getElementById('rain-drops').classList.add('hidden');
        document.getElementById('snow-flakes').classList.add('hidden');
        document.getElementById('heat-waves').classList.add('hidden');
        document.getElementById('rain-drops').innerHTML = '';
        document.getElementById('snow-flakes').innerHTML = '';
        document.getElementById('heat-waves').innerHTML = '';
        // Clear any ongoing weather intervals
        if (gameState.l3.weatherInterval) {
            clearInterval(gameState.l3.weatherInterval);
            gameState.l3.weatherInterval = null;
        }
    }
    
    function startContinuousWeatherEffect(type, effectDiv) {
        // Clear any existing weather interval
        if (gameState.l3.weatherInterval) {
            clearInterval(gameState.l3.weatherInterval);
        }
        
        // Start continuous weather based on type
        if (type === 'rain') {
            gameState.l3.weatherInterval = setInterval(() => {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.animationDelay = Math.random() * 2 + 's';
                effectDiv.appendChild(drop);
                setTimeout(() => drop.remove(), 2000);
            }, 100);
        } else if (type === 'storm') {
            gameState.l3.weatherInterval = setInterval(() => {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                drop.style.left = Math.random() * 100 + '%';
                drop.style.animationDelay = Math.random() * 1 + 's';
                effectDiv.appendChild(drop);
                setTimeout(() => drop.remove(), 1500);
            }, 50);
        } else if (type === 'snow') {
            gameState.l3.weatherInterval = setInterval(() => {
                const flake = document.createElement('div');
                flake.className = 'snow-flake';
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDelay = Math.random() * 3 + 's';
                effectDiv.appendChild(flake);
                setTimeout(() => flake.remove(), 4000);
            }, 200);
        } else if (type === 'blizzard') {
            gameState.l3.weatherInterval = setInterval(() => {
                const flake = document.createElement('div');
                flake.className = 'snow-flake';
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDelay = Math.random() * 1 + 's';
                effectDiv.appendChild(flake);
                setTimeout(() => flake.remove(), 2000);
            }, 80);
        } else if (type === 'heat' || type === 'extreme-heat') {
            gameState.l3.weatherInterval = setInterval(() => {
                const wave = document.createElement('div');
                wave.className = 'heat-wave';
                wave.style.left = Math.random() * 100 + '%';
                wave.style.animationDelay = Math.random() * 2 + 's';
                effectDiv.appendChild(wave);
                setTimeout(() => wave.remove(), 3000);
            }, 150);
        }
    }
    
    function runL3TempChanges() {
        const updateTemp = () => {
            const change = getRandomInt(-5, 5);
            gameState.l3.temperature += change;
            if (gameState.l3.temperature > 40) gameState.l3.temperature = 40;
            if (gameState.l3.temperature < 0) gameState.l3.temperature = 0;
            
            updateWeatherDisplay();
            
            if (gameState.l3.temperature > 35) {
                setInsight("🔥 CRITICAL ALERT! Extreme heat detected! Balloons are extremely fragile - reduce all pump settings immediately!", 3);
            } else if (gameState.l3.temperature > 30) {
                setInsight("🌡️ Heat wave warning! Balloons are more fragile. Consider reducing pump settings to avoid catastrophic losses!", 3);
            } else if (gameState.l3.temperature > 25) {
                setInsight("☀️ Warm conditions detected. Balloons are slightly more fragile. Monitor your settings carefully!", 3);
            } else if (gameState.l3.temperature < 5) {
                setInsight("🧊 BLIZZARD CONDITIONS! Extreme cold makes balloons ultra-stable. You can maximize pump settings for massive profits!", 3);
            } else if (gameState.l3.temperature < 10) {
                setInsight("❄️ Cold snap detected! Balloons are very stable. Increase pump settings for higher profits!", 3);
            } else if (gameState.l3.temperature < 15) {
                setInsight("⛈️ Storm conditions! Unstable weather affects balloon behavior. Adjust settings carefully!", 3);
            } else if (gameState.l3.temperature < 20) {
                setInsight("🌧️ Cool conditions detected. Balloons are stable. Good time to optimize your strategy!", 3);
            } else {
                setInsight("🌤️ Perfect factory conditions! Your AI is performing optimally in ideal weather.", 3);
            }
            
            gameState.l3.tempInterval = setTimeout(updateTemp, getRandomInt(15000, 60000));
        };
        updateTemp();
    }
    
    function runL3Simulation() {
         gameState.l3.interval = setInterval(() => {
            const type = getL2RandomBalloon();
            const config = BALLOON_CONFIG[type];
            const strategyPumps = gameState.l3.strategy[type];
            const tempDiff = gameState.l3.temperature - 20;
            const percentChange = Math.round(tempDiff / 2);
            let [min, max] = [...config.range];
            min = Math.max(1, Math.round(min * (1 - percentChange / 100)));
            max = Math.max(min + 1, Math.round(max * (1 - percentChange / 100)));
            const maxPumps = getRandomInt(min, max);
            let scoreVal = 0;
            if (strategyPumps > maxPumps) { gameState.l3.stats[type].pops++; } else { scoreVal = strategyPumps; gameState.l3.stats[type].score += scoreVal; gameState.l3.totalScore += scoreVal; }
            gameState.l3.stats[type].count++;
            gameState.l3.processedCount = (gameState.l3.processedCount || 0) + 1;
            document.getElementById('l3-balloons-processed').textContent = gameState.l3.processedCount;
            const balloonItem = document.createElement('div');
            balloonItem.className = 'absolute top-1/2 left-1/2 conveyor-belt-item';
            const balloonEl = document.createElement('div');
            balloonEl.className = `balloon bg-${config.color}`;
            balloonEl.style.transform = 'scale(0.5)'; balloonEl.style.color = `var(--tw-bg-${config.color})`;
            balloonItem.appendChild(balloonEl);
            if (scoreVal === 0) { setTimeout(() => { createExplosion(balloonItem, type); balloonEl.style.display = 'none'; }, 2000); }
            l3Conveyor.appendChild(balloonItem);
            setTimeout(() => { if (l3Conveyor.contains(balloonItem)) l3Conveyor.removeChild(balloonItem); }, 4000);
            updateL3Stats();
            saveGameState();
         }, 400);
    }
    
    function updateL3Stats() {
        document.getElementById('l3-total-score').textContent = gameState.l3.totalScore;
        updatePerformanceMonitor('l3');
    }

    // --- Initial Event Listeners ---
    homeBtn.addEventListener('click', () => showScreen('main-menu'));
    helpBtn.addEventListener('click', () => {
        const activeScreenId = document.querySelector('.active-screen').id;
        if (activeScreenId === 'level-1') { gameState.tutorial.l1 = 0; showTutorialStep(L1_TUTORIAL_STEPS, 'l1'); }
        if (activeScreenId === 'level-2') { gameState.tutorial.l2 = 0; showTutorialStep(L2_TUTORIAL_STEPS, 'l2'); }
        if (activeScreenId === 'level-3') { gameState.tutorial.l3 = 0; showTutorialStep(L3_TUTORIAL_STEPS, 'l3'); }
    });
    startGameBtn.addEventListener('click', goToLevelSelect);
    selectL1Btn.addEventListener('click', startLevel1);
    selectL2Btn.addEventListener('click', startLevel2);
    selectL3Btn.addEventListener('click', startLevel3);
    resetProgressBtn.addEventListener('click', resetAllProgress);
    l1PumpBtn.addEventListener('click', handleL1Pump);
    l1BankBtn.addEventListener('click', handleL1Bank);
    document.getElementById('l1-summary-next-btn').addEventListener('click', startLevel2);
    document.getElementById('l1-summary-replay-btn').addEventListener('click', replayLevel1);
    document.getElementById('prev-slide-btn').addEventListener('click', () => renderEducationalSlides('l1', currentSlideIndex - 1));
    document.getElementById('next-slide-btn').addEventListener('click', () => renderEducationalSlides('l1', currentSlideIndex + 1));

    l2StartStopBtn.addEventListener('click', toggleL2Simulation);
    document.getElementById('l2-clear-all-strategies').addEventListener('click', clearAllL2Strategies);
    document.getElementById('l2-skip-to-end-btn').addEventListener('click', skipL2ToEnd);
    document.getElementById('l2-back-to-learn-btn').addEventListener('click', () => showScreen('level-1'));
    l2ModalCloseBtn.addEventListener('click', () => {
        l2CompletionModal.classList.add('hidden');
    });
    l2OpenGameBtn.addEventListener('click', () => {
        startLevel3();
        l2CompletionModal.classList.add('hidden');
    });
    setupL2Controls();
    l3StartStopBtn.addEventListener('click', toggleL3Simulation);
    setupL3Controls();
    
    // --- Custom Tooltip Event Listeners ---
    selectL2Btn.addEventListener('mouseenter', (e) => {
        if (selectL2Btn.disabled) {
            showTooltip('Level 1 must be completed first', e.clientX, e.clientY);
        }
    });
    selectL2Btn.addEventListener('mouseleave', hideTooltip);
    selectL2Btn.addEventListener('mousemove', updateTooltipPosition);
    
    selectL3Btn.addEventListener('mouseenter', (e) => {
        if (selectL3Btn.disabled) {
            showTooltip('Level 2 must be completed first', e.clientX, e.clientY);
        }
    });
    selectL3Btn.addEventListener('mouseleave', hideTooltip);
    selectL3Btn.addEventListener('mousemove', updateTooltipPosition);
    
    // --- Skip Tutorial Event Listener ---
    skipTutorialBtn.addEventListener('click', skipTutorial);
    
    tutorialBox.addEventListener('click', (e) => e.stopPropagation());
    tutorialNextBtn.addEventListener('click', () => {
        const activeScreenId = document.querySelector('.active-screen').id;
        if (!activeScreenId.startsWith('level-')) return;
        const levelKey = 'l' + activeScreenId.slice(-1);
        const steps = levelKey === 'l1' ? L1_TUTORIAL_STEPS : levelKey === 'l2' ? L2_TUTORIAL_STEPS : L3_TUTORIAL_STEPS;
        advanceTutorial(1, steps, levelKey);
    });
    tutorialPrevBtn.addEventListener('click', () => {
        const activeScreenId = document.querySelector('.active-screen').id;
        if (!activeScreenId.startsWith('level-')) return;
        const levelKey = 'l' + activeScreenId.slice(-1);
        const steps = levelKey === 'l1' ? L1_TUTORIAL_STEPS : levelKey === 'l2' ? L2_TUTORIAL_STEPS : L3_TUTORIAL_STEPS;
        advanceTutorial(-1, steps, levelKey);
    });
    
    // --- Load Game on Startup ---
    initGame();
    document.addEventListener('DOMContentLoaded', () => {
        initGame();
        // Trigger initial title animation
        setTimeout(() => {
            animateTitlePage();
        }, 200);
    });

</script>
</body>
</html>

